<!DOCTYPE html>
<html>

<head>
    <title>Processing Payment</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>

<body>
    <h3>Processing your payment...</h3>

    <script>
        const options = {
            key: "<%= key_id %>",
            amount: <%= totalAmount * 100 %>,
            currency: "INR",
            name: "Keitai Shoppe",
            description: "Order Payment",
            order_id: "<%= razorpayOrderId %>",
            handler: async function (response) {
                try {
                    const verifyRes = await fetch("/payment/verify", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_signature: response.razorpay_signature,
                            orderId: "<%= orderId %>"
                        }),
                    });

                    const result = await verifyRes.json();
                    if (result.success) {
                        window.location.href = `/order/success/<%= orderId %>`;
                    } else {
                        window.location.href = `/payment/failed?orderId=<%= orderId %>&error=${encodeURIComponent(result.error)}`;
                    }
                } catch (error) {
                    console.error("Verification error:", error);
                    window.location.href = `/payment/failed?orderId=<%= orderId %>&error=Network error`;
                }
            },
        theme: { color: "#0b76ff" },
    };

        const rzp = new Razorpay(options);
        rzp.open();
    </script>
</body>

</html>