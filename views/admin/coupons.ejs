<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Coupon Management</title>
  <link rel="stylesheet" href="/css/offer.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <nav class="sidebar">
      <div class="logo">
        <img src="/images/logo1.png" alt="Logo">
      </div>
      <ul>
        <li><a href="/admin/dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li><a href="/admin/orders"><i class="fas fa-box"></i> Orders</a></li>
        <li><a href="/admin/products"><i class="fas fa-laptop"></i> Products</a></li>
        <li><a href="/admin/users"><i class="fas fa-users"></i> Users</a></li>
        <li><a href="/admin/categories"><i class="fas fa-th-large"></i> Categories</a></li>
        <li><a href="/admin/coupons" class="active"><i class="fas fa-ticket-alt"></i> Coupons</a></li>
        <li><a href="/admin/payments">Payments</a></li>
        <li><a href="/admin/offers"><i class="fas fa-tags"></i> Offers</a></li>
      </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content">
      <header class="top-bar">
        <div class="admin-controls">
          <span>Admin</span>
          <form action="/admin/logout" method="POST">
            <button type="submit" class="icon-logout"><i class="fas fa-sign-out-alt"></i> Logout</button>
          </form>
        </div>
      </header>

      <section class="offer-management">
        <div class="section-header">
          <h2>Manage Coupons</h2>
        </div>

        <!-- Flash Messages -->
        <% if (messages.success) { %>
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <%= messages.success %>
              <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
          </div>
          <% } %>
            <% if (messages.error) { %>
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle"></i>
                <%= messages.error %>
                  <button type="button" class="close" onclick="this.parentElement.style.display='none'">&times;</button>
              </div>
              <% } %>

                <!-- Create New Coupon Form -->
                <form action="/admin/coupons/create" method="POST" style="margin-bottom: 30px;">
                  <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                    <input type="text" name="code" placeholder="Coupon Code" required style="flex: 1; padding: 10px;">

                    <select name="discountType" required style="flex: 1; padding: 10px;">
                      <option value="">-- Select Type --</option>
                      <option value="percentage">Percentage (%)</option>
                      <option value="fixed">Fixed Amount</option>
                    </select>

                    <input type="number" name="discount" placeholder="Discount Value" min="1" required
                      style="flex: 1; padding: 10px;">

                    <!-- NEW FIELD: Minimum Purchase -->
                    <div id="minPurchaseField" style="flex: 1; display: none;">
                      <input type="number" name="minPurchase" placeholder="Min Purchase Amount (₹)" min="0"
                        style="width: 100%; padding: 10px;">
                    </div>

                    <!-- Max Discount (only applies to percentage) -->
                    <div id="maxDiscountField" style="flex: 1; display: none;">
                      <input type="number" name="maxDiscount" placeholder="Max Discount Amount (₹)" min="0"
                        style="width: 100%; padding: 10px;">
                    </div>

                    <input type="date" name="startDate" id="couponStartDate" required style="flex: 1; padding: 10px;">
                    <input type="date" name="endDate" id="couponEndDate" required style="flex: 1; padding: 10px;">

                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus"></i> Add Coupon</button>
                  </div>
                </form>


                <!-- Coupons Table -->
                <div class="table-responsive">
                  <table class="offer-table">
                    <thead>
                      <tr>
                        <th>Code</th>
                        <th>Type</th>
                        <th>Discount</th>
                        <th>Min Purchase</th>
                        <th>Max Discount</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
  <% coupons.forEach(coupon=> { %>
    <tr>
      <td><%= coupon.code %></td>
      <td><%= coupon.discountType==='percentage' ? 'Percentage' : 'Fixed' %></td>
      <td><%= coupon.discountType==='percentage' ? coupon.discount + ' %' : '₹' + coupon.discount %></td>
      <td>₹<%= coupon.minPurchase || 0 %></td>
      <td><%= coupon.discountType==='percentage' ? '₹' + (coupon.maxDiscount || 'No Limit') : '-' %></td>
      <td><%= new Date(coupon.startDate).toLocaleDateString() %></td>
      <td><%= new Date(coupon.endDate).toLocaleDateString() %></td>
      <td><%= new Date(coupon.endDate) > new Date() ? 'Active' : 'Expired' %></td>

      <!-- ✅ Only one Actions column -->
      <td class="actions">
        <!-- Edit Button -->
        <button type="button" 
          class="btn btn-sm btn-edit" 
          data-id="<%= coupon._id %>"
          data-code="<%= coupon.code %>"
          data-type="<%= coupon.discountType %>"
          data-discount="<%= coupon.discount %>"
          data-minpurchase="<%= coupon.minPurchase %>"
          data-maxdiscount="<%= coupon.maxDiscount %>"
          data-start="<%= coupon.startDate.toISOString().split('T')[0] %>"
          data-end="<%= coupon.endDate.toISOString().split('T')[0] %>">
          <i class="fas fa-edit"></i>
        </button>

        <!-- Delete Button -->
        <form action="/admin/coupons/delete/<%= coupon._id %>" method="POST"
          onsubmit="return confirm('Delete this coupon?')">
          <button class="btn btn-sm btn-delete"><i class="fas fa-trash"></i></button>
        </form>
      </td>
    </tr>
  <% }) %>
</tbody>
                  </table>
                  <div class="pagination">
                    <% if (totalPages> 1) { %>
                      <ul>
                        <% if (currentPage> 1) { %>
                          <li><a href="?page=<%= currentPage - 1 %>">&laquo; Previous</a></li>
                          <% } %>

                            <% for(let i=1; i <=totalPages; i++) { %>
                              <li class="<%= currentPage === i ? 'active' : '' %>">
                                <a href="?page=<%= i %>">
                                  <%= i %>
                                </a>
                              </li>
                              <% } %>

                                <% if (currentPage < totalPages) { %>
                                  <li><a href="?page=<%= currentPage + 1 %>">Next &raquo;</a></li>
                                  <% } %>
                      </ul>
                      <% } %>
                  </div>
                </div>
      </section>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    document.getElementById('couponStartDate').addEventListener('change', function () {
      const startDate = this.value;
      const endDateInput = document.getElementById('couponEndDate');

      endDateInput.min = startDate;

      if (endDateInput.value && endDateInput.value < startDate) {
        endDateInput.value = startDate;
      }
    });

    const couponForm = document.querySelector('form[action="/admin/coupons/create"]');

    couponForm.addEventListener('submit', function (e) {
      const discountType = couponForm.querySelector('select[name="discountType"]').value;
      const discount = parseFloat(couponForm.querySelector('input[name="discount"]').value);
      const startDate = couponForm.querySelector('input[name="startDate"]').value;
      const endDate = couponForm.querySelector('input[name="endDate"]').value;

      if (new Date(endDate) < new Date(startDate)) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Invalid Date Range',
          text: 'End date cannot be before start date.'
        });
        return;
      }
      if (discountType === 'percentage') {
        if (discount < 1 || discount > 90) {
          e.preventDefault();
          Swal.fire({
            icon: 'error',
            title: 'Invalid Discount',
            text: 'Percentage discount must be between 1% and 90%.'
          });
          return;
        }
      } else if (discountType === 'fixed') {
        if (discount < 2000 || discount > 50000) {
          e.preventDefault();
          Swal.fire({
            icon: 'error',
            title: 'Invalid Discount',
            text: 'Fixed discount must be between ₹2000 and ₹50,000.'
          });
          return;
        }
      } else {
        e.preventDefault();
        Swal.fire({
          icon: 'warning',
          title: 'Discount Type Required',
          text: 'Please select a discount type.'
        });
        return;
      }
    });

    `<% if (messages && messages.success) { %>
      Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: "<%- messages.success %>"
      });
    <% } %>

    <% if (messages && messages.error) { %>
      Swal.fire({
        icon: 'error',
        title: 'Oops!',
        text: "<%- messages.error %>"
      });
    <% } %>`
    const discountTypeSelect = document.querySelector('select[name="discountType"]');
    const minPurchaseField = document.getElementById('minPurchaseField');
    const maxDiscountField = document.getElementById('maxDiscountField');

    discountTypeSelect.addEventListener('change', function () {
      if (this.value === 'percentage') {
        minPurchaseField.style.display = 'block';
        maxDiscountField.style.display = 'block';
        minPurchaseField.querySelector('input').required = true;
        maxDiscountField.querySelector('input').required = true;
      } else if (this.value === 'fixed') {
        minPurchaseField.style.display = 'block';
        maxDiscountField.style.display = 'none';
        minPurchaseField.querySelector('input').required = true;
        maxDiscountField.querySelector('input').required = false;
      } else {
        minPurchaseField.style.display = 'none';
        maxDiscountField.style.display = 'none';
        minPurchaseField.querySelector('input').required = false;
        maxDiscountField.querySelector('input').required = false;
      }
    });


    discountTypeSelect.dispatchEvent(new Event('change'));
document.querySelectorAll('.btn-edit').forEach(button => {
  button.addEventListener('click', function () {
    const id = this.dataset.id;
    const code = this.dataset.code;
    const type = this.dataset.type;
    const discount = this.dataset.discount;
    const minPurchase = this.dataset.minpurchase;
    const maxDiscount = this.dataset.maxdiscount;
    const start = this.dataset.start;
    const end = this.dataset.end;

   Swal.fire({
  title: 'Edit Coupon',
  html: `
    <form id="editCouponForm" action="/admin/coupons/edit/${id}" method="POST">
      <input type="text" name="code" value="${code}" placeholder="Coupon Code" class="swal2-input" required>
      <select id="editDiscountType" name="discountType" class="swal2-input" required>
        <option value="percentage" ${type === 'percentage' ? 'selected' : ''}>Percentage (%)</option>
        <option value="fixed" ${type === 'fixed' ? 'selected' : ''}>Fixed Amount</option>
      </select>
      <input type="number" id="editDiscount" name="discount" value="${discount}" placeholder="Discount" class="swal2-input" required>
      <input type="number" id="editMinPurchase" name="minPurchase" value="${minPurchase || ''}" placeholder="Min Purchase" class="swal2-input">
      <input type="number" id="editMaxDiscount" name="maxDiscount" value="${maxDiscount || ''}" placeholder="Max Discount" class="swal2-input">
      <input type="date" id="editStartDate" name="startDate" value="${start}" class="swal2-input" required>
      <input type="date" id="editEndDate" name="endDate" value="${end}" class="swal2-input" required>
    </form>
  `,
  focusConfirm: false,
  preConfirm: () => {
    const discountType = document.getElementById("editDiscountType").value;
    const discount = parseFloat(document.getElementById("editDiscount").value);
    const startDate = document.getElementById("editStartDate").value;
    const endDate = document.getElementById("editEndDate").value;

    if (new Date(endDate) < new Date(startDate)) {
      Swal.showValidationMessage("End date cannot be before start date.");
      return false;
    }
    if (discountType === "percentage" && (discount < 1 || discount > 90)) {
      Swal.showValidationMessage("Percentage discount must be between 1% and 90%.");
      return false;
    }
    if (discountType === "fixed" && (discount < 2000 || discount > 50000)) {
      Swal.showValidationMessage("Fixed discount must be between ₹2000 and ₹50,000.");
      return false;
    }

    document.getElementById("editCouponForm").submit();
  },
  showCancelButton: true,
  confirmButtonText: 'Update',
  cancelButtonText: 'Cancel'
});

  });
});

  </script>
</body>

</html>