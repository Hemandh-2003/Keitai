<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Edit Offer</title>
  <link rel="stylesheet" href="/css/edit-offer.css">
</head>
<body>
  <h1>Edit Offer</h1>
 <form action="/admin/offers/update/<%= offer._id %>" method="POST">

  <label>Offer Name:</label>
  <input type="text" name="name" value="<%= offer.name %>" required><br>

  <label>Description:</label>
  <textarea name="description"><%= offer.description || '' %></textarea><br>

  <label>Offer Type:</label>
  <select name="offerType" required>
    <% offerTypes.forEach(type => { %>
      <option value="<%= type %>" <%= offer.offerType === type ? 'selected' : '' %>><%= type %></option>
    <% }) %>
  </select><br>

  <label>Discount Type:</label>
  <select name="discountType" required>
    <% discountTypes.forEach(type => { %>
      <option value="<%= type %>" <%= offer.discountType === type ? 'selected' : '' %>><%= type %></option>
    <% }) %>
  </select><br>

  <label>Discount Value:</label>
  <input type="number" name="discountValue" value="<%= offer.discountValue %>" required><br>

  <label>Start Date:</label>
  <input type="date" name="startDate" value="<%= new Date(offer.startDate).toISOString().split('T')[0] %>" required><br>

  <label>End Date:</label>
  <input type="date" name="endDate" value="<%= new Date(offer.endDate).toISOString().split('T')[0] %>" required><br>

  <label>Status:</label>
  <input type="checkbox" name="isActive" <%= offer.isActive ? 'checked' : '' %>> Active<br>

 <!-- Product Selector (for product offers) -->
<div id="product-section" style=`<%= offer.offerType === 'product' ? '' : 'display:none;' %>`>
  <label>Select Products:</label><br>
  <% products.forEach(product => { %>
    <label>
      <input type="checkbox" name="products" value="<%= product._id %>" 
        <%= selectedProducts.includes(product._id.toString()) ? 'checked' : '' %>>
      <%= product.name %>
    </label><br>
  <% }) %>
</div>

<!-- Category Selector (for category offers) -->
<div id="category-section" style=`<%= offer.offerType === 'category' ? '' : 'display:none;' %>`>
  <label>Select Categories:</label><br>
  <% categories.forEach(category => { %>
    <label>
      <input type="checkbox" name="categories" value="<%= category._id %>" 
        <%= selectedCategories.includes(category._id.toString()) ? 'checked' : '' %>>
      <%= category.name %>
    </label><br>
  <% }) %>
</div>

  <!-- Referral Fields (for referral offers) -->
  <div id="referral-section" style=`<%= offer.offerType === 'referral' ? '' : 'display:none;' %>`>
    <label>Referral Code:</label>
    <input type="text" name="referralCode" value="<%= offer.referralCode || '' %>"><br>

    <label>Referrer Bonus (₹):</label>
    <input type="number" name="referrerBonus" value="<%= offer.referrerBonus || '' %>"><br>

    <label>Referee Bonus (₹):</label>
    <input type="number" name="refereeBonus" value="<%= offer.refereeBonus || '' %>"><br>

    <label>Minimum Purchase Amount (₹):</label>
    <input type="number" name="minPurchaseAmount" value="<%= offer.minPurchaseAmount || '' %>"><br>
  </div>

  <button type="submit">Update Offer</button>
</form>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  const editForm = document.querySelector('form');
  const offerTypeSelect = editForm.querySelector('select[name="offerType"]');
  const discountTypeSelect = editForm.querySelector('select[name="discountType"]');
  const discountValueInput = editForm.querySelector('input[name="discountValue"]');
  const startDateInput = editForm.querySelector('input[name="startDate"]');
  const endDateInput = editForm.querySelector('input[name="endDate"]');

  // Show/hide relevant sections based on offer type
  offerTypeSelect.addEventListener('change', () => {
    document.getElementById('product-section').style.display = 'none';
    document.getElementById('category-section').style.display = 'none';
    document.getElementById('referral-section').style.display = 'none';

    const type = offerTypeSelect.value;
    if (type === 'product') {
      document.getElementById('product-section').style.display = '';
    } else if (type === 'category') {
      document.getElementById('category-section').style.display = '';
    } else if (type === 'referral') {
      document.getElementById('referral-section').style.display = '';
    }
  });

  // Validate before submit
  editForm.addEventListener('submit', function (e) {
    const discountType = discountTypeSelect.value;
    const discount = parseFloat(discountValueInput.value);
    const start = new Date(startDateInput.value);
    const end = new Date(endDateInput.value);

    // Validate dates
    if (start >= end) {
      e.preventDefault();
      Swal.fire({
        icon: 'warning',
        title: 'Invalid Dates',
        text: 'End date must be after start date',
      });
      return;
    }

    // Validate discount range
    if (discountType === 'percentage') {
      if (discount < 1 || discount > 90) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Invalid Discount',
          text: 'Percentage discount must be between 1% and 90%',
        });
        return;
      }
    } else if (discountType === 'fixed') {
      if (discount < 1 || discount > 50000) {
        e.preventDefault();
        Swal.fire({
          icon: 'error',
          title: 'Invalid Discount',
          text: 'Fixed discount must be between ₹1 and ₹50,000',
        });
        return;
      }
    } else {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Missing Discount Type',
        text: 'Please select a valid discount type',
      });
    }
  });

  // Trigger section toggle on initial load (for edit pre-filled value)
  document.addEventListener('DOMContentLoaded', () => {
    const event = new Event('change');
    offerTypeSelect.dispatchEvent(event);
  });
</script>

</body>
</html>
